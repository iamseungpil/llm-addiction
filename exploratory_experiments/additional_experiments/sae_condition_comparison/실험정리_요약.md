# SAE Condition Comparison 실험 정리 요약

**정리일**: 2026-02-02
**실험 경로**: `exploratory_experiments/additional_experiments/sae_condition_comparison/`

---

## 🎯 실험 목적

**Variable vs Fixed 베팅 조건이 SAE 피처에 미치는 영향 분석**

- Variable 조건에서 파산율이 2.6배 높음 (LLaMA 2.6% → 6.8%, Gemma 12.8% → 29.1%)
- 이 차이가 신경 표현 수준에서 어떻게 나타나는가?
- 베팅 조건이라는 외생 변수가 모델 내부에 인코딩되는가?

---

## 📁 생성된 문서

### 1. **EXPERIMENT_SUMMARY.md** (신규 작성)
   - **내용**: 전체 실험의 포괄적 정리
   - **포함**:
     - 실험 목적 및 배경
     - 디렉토리 구조 (시각화된 트리)
     - 3+1가지 분석 파이프라인 상세 설명
     - 코드 구조 및 사용법
     - 주요 발견 및 통계적 이슈
     - 실행 방법 및 명령어
   - **대상**: 새로운 연구자 또는 미래의 자신

### 2. **CLEANUP_GUIDE.md** (신규 작성)
   - **내용**: 파일 정리 가이드
   - **포함**:
     - 중복 파일 목록 (9.5GB 절약 가능)
     - 삭제 안전성 평가
     - 백업 전략
     - 자동화 스크립트 설명
   - **대상**: 디스크 공간 확보 필요 시

### 3. **scripts/cleanup_duplicates.sh** (신규 작성)
   - **내용**: 자동 정리 실행 스크립트
   - **기능**:
     - 중복 Gemma 결과 백업 (7개 파일, ~9.5GB)
     - 중복 LLaMA 프롬프트 결과 백업
     - 구버전 스크립트 _deprecated로 이동
     - 오래된 로그 gzip 압축
     - 백업 디렉토리 생성 (복구 가능)
   - **사용법**: `bash scripts/cleanup_duplicates.sh`

---

## 📊 주요 발견 요약

### 1. 모델별 인코딩 전략
- **LLaMA**: 베팅 조건을 L12-15에 인코딩 (Cohen's d 최대 4.75)
- **Gemma**: 결과(파산/안전)를 L26-40에 인코딩 (활성화 50배 차이)

### 2. 통계적 이슈 (중요!)
| 분석 | 신뢰도 | 상태 |
|------|--------|------|
| Analysis 1: Variable vs Fixed t-test | ✅ 높음 | 사용 가능 |
| Analysis 2: Four-Way ANOVA | ⚠️ 중간 | 주의하여 사용 |
| Analysis 3: Interaction | ❌ 낮음 | 🔴 **재분석 필요** |

**핵심 문제**: 92%의 피처가 interaction_eta ≈ 1.0 (sparse feature artifact)
- **원인**: 활성화율 < 0.12% (3200개 게임 중 4개만 활성)
- **해결**: `activation_rate >= 1%` 필터링 후 재분석

### 3. 샘플 크기 불균형
- Fixed-Bankrupt: 42개 (LLaMA) - 통계적 검정력 부족
- Bootstrap CI로 안정성 검증 권장

---

## 🗂️ 파일 상태

### 보관 필요 (삭제 금지)
```
results/
├── *_llama_20260127_150824.json       # LLaMA 최종 결과
├── *_gemma_20260127_203709.json       # Gemma 최신 결과 (3번째 실행)
├── two_way_anova_llama_*.json         # 2-way ANOVA
├── figures/*.png                      # 18개 그래프
└── prompt_*/*.json                    # 프롬프트 분석 결과
```

### 삭제 가능 (중복)
```
results/
├── *_gemma_20260127_203518.json       # 1번째 실행 (중복)
├── *_gemma_20260127_203626.json       # 2번째 실행 (중복)
└── G_llama_20260201_230709.json       # 이전 실행 (중복)

절약: ~9.5GB
```

### 구버전 (이동 권장)
```
scripts/
├── visualize_results.py               # → _deprecated/
└── visualize_all_results.py           # → _deprecated/
```

---

## ✅ 실행한 정리 작업

### 문서 작성
1. ✅ `EXPERIMENT_SUMMARY.md` 작성 (실험 전체 요약)
2. ✅ `CLEANUP_GUIDE.md` 작성 (정리 가이드)
3. ✅ `scripts/cleanup_duplicates.sh` 작성 (자동 정리)
4. ✅ `실험정리_요약.md` 작성 (이 파일)

### 코드 분석
- ✅ 디렉토리 구조 파악 (29개 파일)
- ✅ 소스 코드 라인 수 계산 (2,215 lines)
- ✅ 결과 파일 크기 확인 (17GB total)
- ✅ 중복 파일 식별 (9.5GB 삭제 가능)
- ✅ 기존 문서 검토 (12개 마크다운)

---

## 🚀 다음 단계 (권장 순서)

### 즉시 실행
1. **정리 스크립트 실행** (선택적)
   ```bash
   cd /mnt/c/Users/oollccddss/git/llm-addiction/exploratory_experiments/additional_experiments/sae_condition_comparison
   bash scripts/cleanup_duplicates.sh
   # 백업 확인 후 7일 뒤 삭제: rm -rf backup_*
   ```

### 논문 제출 전
2. **Sparse feature 필터링 재분석**
   ```python
   # src/condition_comparison.py 수정
   # analyze_interaction_layer() 함수에 필터 추가:

   activation_rate = np.count_nonzero(features, axis=0) / features.shape[0]
   valid_mask = activation_rate >= 0.01  # 1% threshold
   features = features[:, valid_mask]
   ```

3. **상위 100개 피처 statsmodels 검증**
   ```python
   from statsmodels.formula.api import ols
   from statsmodels.stats.anova import anova_lm

   # Two-way ANOVA 정확히 재계산
   ```

4. **Bootstrap CI 추가** (Fixed-Bankrupt n=42)
   ```python
   from scipy.stats import bootstrap
   # 신뢰 구간 계산
   ```

### 문서화
5. **논문 Limitations 섹션 작성**
   - 샘플 불균형 명시 (FB: 42, VB: 108)
   - SAE 스케일 차이 설명 (LLaMA vs Gemma)
   - Two-way ANOVA 근사 계산 설명
   - Dead feature 제외 기준 명시

6. **Methods 섹션 보강**
   - 통계 분석 방법 상세 기술
   - Sparse feature 처리 방법
   - FDR 보정 설명

---

## 📚 중요 문서 위치

### 필수 참조
1. **ANALYSIS_ISSUES_REPORT.md** ⚠️
   - 5가지 통계적 이슈 상세 설명
   - 해결 방법 및 권장 조치

2. **INTERACTION_ETA_PROBLEM_EXPLAINED.md**
   - Sparse feature artifact 원인 분석
   - 수치 예시 및 시각화

3. **TWO_WAY_ANOVA_GUIDE.md**
   - 근사 vs 정확 계산 비교
   - 언제 어떤 방법을 사용할지

4. **EXPERIMENT_SUMMARY.md** (신규)
   - 전체 실험 포괄적 요약
   - 코드 구조 및 사용법

5. **CLEANUP_GUIDE.md** (신규)
   - 파일 정리 가이드
   - 디스크 절약 전략

---

## 💾 디스크 사용량

### 현재 상태
- **results/**: ~17GB (중복 포함)
- **logs/**: ~수백 MB
- **src/ + scripts/**: ~수 MB

### 정리 후 예상
- **results/**: ~7.5GB (중복 제거)
- **절약**: 9.5GB
- **백업**: backup_* (7일 보관)

### 추가 최적화
- **Interaction 재분석 후 삭제**: 3.4GB (LLaMA) + 5.8GB (Gemma)
- **Four-way 외부 아카이브**: 619MB (LLaMA) + 3.3GB (Gemma)
- **압축 아카이브**: 17GB → 1-2GB (90% 압축)

---

## 🔍 빠른 참조

### 분석 실행
```bash
# 메인 분석
python -m src.condition_comparison --model llama
python -m src.condition_comparison --model gemma

# Two-way ANOVA
python -m src.two_way_anova_analysis --model llama

# 프롬프트 분석
python -m src.prompt_component_analysis --model llama
python -m src.prompt_complexity_analysis --model llama
python -m src.prompt_combo_explorer --model llama
```

### 시각화
```bash
# 메인 결과
python scripts/visualize_results_improved.py

# Two-way ANOVA
python scripts/visualize_two_way_anova_heatmap.py

# 프롬프트 분석
python scripts/visualize_prompt_results.py
```

### 정리
```bash
# 중복 파일 정리 (백업 생성)
bash scripts/cleanup_duplicates.sh

# 백업 확인 후 삭제 (7일 후)
rm -rf backup_*
```

---

## ⚠️ 주의사항

1. **Interaction 결과 사용 금지** (재분석 전까지)
   - 현재 결과는 통계적 아티팩트 포함
   - 논문에는 Supplementary에만 배치 (주의 사항과 함께)

2. **절대값 비교 금지**
   - LLaMA vs Gemma 활성화 절대값은 비교 불가 (SAE 스케일 다름)
   - 상대적 패턴만 해석 가능 (Bankrupt/Safe 비율 등)

3. **샘플 크기 명시**
   - Fixed-Bankrupt: 42개 (LLaMA)
   - 모든 분석 결과에 샘플 크기 병기 필요

4. **백업 검증**
   - 파일 삭제 전 반드시 백업 무결성 확인
   - 백업 7일 보관 후 제거

---

## 📞 추가 질문

### 통계 관련
→ `ANALYSIS_ISSUES_REPORT.md` 참조

### 코드 사용법
→ `README.md` 및 `EXPERIMENT_SUMMARY.md` 참조

### 결과 해석
→ `SAE_Condition_Comparison_Results.md` 참조

### Figure 설명
→ `results/SAE_Figure_Analysis_Guide.md` 참조

---

## 🎉 정리 완료

**생성된 문서**: 4개
- EXPERIMENT_SUMMARY.md (포괄적 실험 정리)
- CLEANUP_GUIDE.md (파일 정리 가이드)
- scripts/cleanup_duplicates.sh (자동 정리 스크립트)
- 실험정리_요약.md (이 파일)

**분석된 항목**:
- 디렉토리 구조 (29개 파일)
- 소스 코드 (2,215 lines)
- 결과 파일 (17GB, 중복 9.5GB)
- 문서 (12개 기존 + 4개 신규)

**다음 작업**:
1. 선택적으로 cleanup_duplicates.sh 실행 (9.5GB 절약)
2. Sparse feature 필터링 재분석 (논문 제출 전 필수)
3. 상위 피처 statsmodels 검증 (논문 Figure용)

---

**정리 완료**: 2026-02-02
**상태**: ✅ 문서화 완료, 정리 스크립트 준비됨
**실행 대기**: cleanup_duplicates.sh (선택적)
